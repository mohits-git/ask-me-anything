<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session | AMA</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }

        h1,
        h2,
        h3 {
            color: #333;
        }

        form {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            padding: 10px 15px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #218838;
        }
    </style>
</head>

<body>
    {% if session %}
    <h1>ASK, {{ session.name }}</h1>

    {% else %}
    <h1>Invalid Session</h1>
    {% endif %}


    {% if questions %}
    <ul>
    {% for question in questions %}
        <li>
            <span>Question: {{ question.question }}</span> <br/>
            {% if question.answer %}
                <span>Answer: {{question.answer}}</span>
            {% else %}
                {% if password %}
                    <div>
                        <span>Post Your Answer:</span>
                        <form id="answer-form">
                            <input type="text" name="question_id" value="{{ question.id }}" style="display: none;" />
                            <input type="password" name="password" value="{{ password }}" style="display: none;" />
                            <input type="text" name="answer" placeholder="Answer" />
                            <button>Post</button>
                        </form>
                    </div>
                {% endif %}
            {% endif %}
        </li>
    {% endfor %}
    </ul>
    {% else %}
    <h1>No Questions Asked Yet!</h1>
    {% endif %}

    {% if session %}
        <h3>Ask a question from {{ session.name }}</h3>
        <form id="question-submit-form">
            <input name="session_id" value="{{ session.id }}" style="display: none;" />
            <input type="text" name="question" placeholder="enter your question...">
            <button>Ask!</button>
        </form>
    {% endif %}


    <script>
        const form = document.querySelector("#answer-form");

        form?.addEventListener("submit", async function (event) {
            event.preventDefault();

            const formData = new FormData(form);
            const question_id = formData.get("question_id")?.toString();
            if (!question_id) return;
            const answer = formData.get("answer")?.toString();
            if (!answer) return;
            const password = formData.get("password")?.toString();
            if (!password) return;

            await fetch(`http://localhost:5000/api/questions/${question_id}`, {
                method: "PATCH",
                headers: {
                    Authorization: `Basic ${password}`,
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ answer: answer }),
            });

            window.location.reload();
        });

        const questionForm = document.querySelector("#question-submit-form");

        questionForm?.addEventListener("submit", async function (event) {
            event.preventDefault();

            const formData = new FormData(questionForm);
            const session_id = formData.get("session_id");
            const question = formData.get("question");

            await fetch("http://localhost:5000/api/questions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ session_id: session_id, question: question }),
            });

            window.location.reload()
        });

    </script>
</body>

</html>
